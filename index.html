<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmTrack - Fleet & Fuel Manager</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#15803d">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="header-brand">
                <div class="brand-icon">üöß</div>
                <h1>Fuel Manager</h1>
            </div>
            <nav class="nav">
                <button id="nav-fuel-entry" class="nav-btn active">Fuel Entry</button>
                <button id="nav-dashboard" class="nav-btn">Dashboard</button>
                <button id="nav-vehicles" class="nav-btn">Vehicles</button>
                <button id="nav-drivers" class="nav-btn">Drivers</button>
                <button id="nav-bowsers" class="nav-btn">Bowsers</button>
            </nav>
        </header>

        <main class="main">
            <!-- Fuel Entry Flow -->
            <section id="fuel-entry-section" class="section active">
                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">Step 1 of 5</div>
                </div>
                
                <div class="container">
                    <!-- Step 1: Vehicle Selection -->
                    <div id="step-vehicle" class="step active">
                        <h2>Select Vehicle</h2>
                        <div class="table-container">
                            <table class="table" id="vehicle-table">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th>Registration</th>
                                    </tr>
                                </thead>
                                <tbody id="vehicle-table-body">
                                    <!-- Vehicles will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Step 2: Driver Selection -->
                    <div id="step-driver" class="step hidden">
                        <h2>Select Driver</h2>
                        <button class="back-btn" id="back-to-vehicle">‚Üê Back to Vehicles</button>
                        <div class="table-container">
                            <table class="table" id="driver-table">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th>License</th>
                                    </tr>
                                </thead>
                                <tbody id="driver-table-body">
                                    <!-- Drivers will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Step 3: Activity Selection -->
                    <div id="step-activity" class="step hidden">
                        <h2>Select Activity</h2>
                        <button class="back-btn" id="back-to-driver">‚Üê Back to Drivers</button>
                        <div class="form-container">
                            <div class="selected-info">
                                <div class="info-card">
                                    <div id="selected-vehicle-info"></div>
                                </div>
                                <div class="info-card">
                                    <div id="selected-driver-info"></div>
                                </div>
                            </div>
                            
                            <div class="activity-categories">
                                <!-- Field & Orchard Prep -->
                                <div class="activity-category">
                                    <h3 class="category-title">Field & Orchard Prep</h3>
                                    <div class="activity-grid">
                                        <button class="activity-btn" data-activity="V-CLR" data-name="Clearing & Grubbing">
                                            <span class="activity-icon">üå≤</span>
                                            <span class="activity-code">V-CLR</span>
                                            <span class="activity-name">Clearing</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-PLW" data-name="Ploughing">
                                            <span class="activity-icon">üöú</span>
                                            <span class="activity-code">V-PLW</span>
                                            <span class="activity-name">Ploughing</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-DSC" data-name="Discing">
                                            <span class="activity-icon">‚öôÔ∏è</span>
                                            <span class="activity-code">V-DSC</span>
                                            <span class="activity-name">Discing</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-RIP" data-name="Ripping">
                                            <span class="activity-icon">üî©</span>
                                            <span class="activity-code">V-RIP</span>
                                            <span class="activity-name">Ripping</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-RDG" data-name="Ridging / Bed-forming">
                                            <span class="activity-icon">üèîÔ∏è</span>
                                            <span class="activity-code">V-RDG</span>
                                            <span class="activity-name">Ridging</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-PLT" data-name="Planting (Mechanical)">
                                            <span class="activity-icon">üå±</span>
                                            <span class="activity-code">V-PLT</span>
                                            <span class="activity-name">Planting</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Inputs & Application -->
                                <div class="activity-category">
                                    <h3 class="category-title">Inputs & Application</h3>
                                    <div class="activity-grid">
                                        <button class="activity-btn" data-activity="V-FER" data-name="Fertiliser (Mechanical)">
                                            <span class="activity-icon">üß™</span>
                                            <span class="activity-code">V-FER</span>
                                            <span class="activity-name">Fertiliser</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-PES" data-name="Pest Control (Spraying)">
                                            <span class="activity-icon">ü¶ü</span>
                                            <span class="activity-code">V-PES</span>
                                            <span class="activity-name">Pest Control</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-WED" data-name="Weed Control (Spraying)">
                                            <span class="activity-icon">üåø</span>
                                            <span class="activity-code">V-WED</span>
                                            <span class="activity-name">Weed Control</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Monitoring & Management -->
                                <div class="activity-category">
                                    <h3 class="category-title">Monitoring & Management</h3>
                                    <div class="activity-grid">
                                        <button class="activity-btn" data-activity="V-SCT" data-name="Scouting & Monitoring (Driving)">
                                            <span class="activity-icon">üîç</span>
                                            <span class="activity-code">V-SCT</span>
                                            <span class="activity-name">Scouting</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Orchard Maintenance -->
                                <div class="activity-category">
                                    <h3 class="category-title">Orchard Maintenance</h3>
                                    <div class="activity-grid">
                                        <button class="activity-btn" data-activity="V-MOW" data-name="Mowing / Slashing">
                                            <span class="activity-icon">‚úÇÔ∏è</span>
                                            <span class="activity-code">V-MOW</span>
                                            <span class="activity-name">Mowing</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-MUL" data-name="Chipping & Spreading Mulch">
                                            <span class="activity-icon">ü™µ</span>
                                            <span class="activity-code">V-MUL</span>
                                            <span class="activity-name">Mulching</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-PRN" data-name="Pruning (Mechanical)">
                                            <span class="activity-icon">‚úÇÔ∏è</span>
                                            <span class="activity-code">V-PRN</span>
                                            <span class="activity-name">Pruning</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-THN" data-name="Thinning (Mechanical)">
                                            <span class="activity-icon">üåø</span>
                                            <span class="activity-code">V-THN</span>
                                            <span class="activity-name">Thinning</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- General Farm Maintenance -->
                                <div class="activity-category">
                                    <h3 class="category-title">General Farm Maintenance</h3>
                                    <div class="activity-grid">
                                        <button class="activity-btn" data-activity="V-ROD" data-name="Road Maintenance">
                                            <span class="activity-icon">üõ§Ô∏è</span>
                                            <span class="activity-code">V-ROD</span>
                                            <span class="activity-name">Roads</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-FIR" data-name="Firebreak Maintenance">
                                            <span class="activity-icon">üî•</span>
                                            <span class="activity-code">V-FIR</span>
                                            <span class="activity-name">Firebreaks</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-WWY" data-name="Waterway/Erosion Mgt.">
                                            <span class="activity-icon">üíß</span>
                                            <span class="activity-code">V-WWY</span>
                                            <span class="activity-name">Waterways</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-IRR" data-name="Irrigation Operation">
                                            <span class="activity-icon">üí¶</span>
                                            <span class="activity-code">V-IRR</span>
                                            <span class="activity-name">Irrigation</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Harvest & Handling -->
                                <div class="activity-category">
                                    <h3 class="category-title">Harvest & Handling</h3>
                                    <div class="activity-grid">
                                        <button class="activity-btn" data-activity="V-HRV" data-name="Harvesting (Mechanical)">
                                            <span class="activity-icon">üåæ</span>
                                            <span class="activity-code">V-HRV</span>
                                            <span class="activity-name">Harvesting</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-LOD" data-name="Crop Loading & Stacking">
                                            <span class="activity-icon">üì¶</span>
                                            <span class="activity-code">V-LOD</span>
                                            <span class="activity-name">Loading</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Transport -->
                                <div class="activity-category">
                                    <h3 class="category-title">Transport</h3>
                                    <div class="activity-grid">
                                        <button class="activity-btn" data-activity="V-TRN" data-name="On-Farm Haulage">
                                            <span class="activity-icon">üöõ</span>
                                            <span class="activity-code">V-TRN</span>
                                            <span class="activity-name">Haulage</span>
                                        </button>
                                        <button class="activity-btn" data-activity="V-TMK" data-name="Transport to Market">
                                            <span class="activity-icon">üè™</span>
                                            <span class="activity-code">V-TMK</span>
                                            <span class="activity-name">To Market</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Field Selection -->
                    <div id="step-field" class="step hidden">
                        <h2>Select Field/Location</h2>
                        <button class="back-btn" id="back-to-activity">‚Üê Back to Activity</button>
                        <div class="form-container">
                            <div class="selected-info">
                                <div class="info-card">
                                    <div id="selected-vehicle-info-3"></div>
                                </div>
                                <div class="info-card">
                                    <div id="selected-driver-info-3"></div>
                                </div>
                                <div class="info-card">
                                    <div id="selected-activity-info"></div>
                                </div>
                            </div>
                            
                            <div class="field-selection">
                                <div class="table-container">
                                    <table class="table field-table">
                                        <thead>
                                            <tr>
                                                <th>Field/Location</th>
                                                <th>Type</th>
                                            </tr>
                                        </thead>
                                        <tbody id="field-table-body">
                                            <tr class="field-row" data-field="North Field A">
                                                <td><strong>North Field A</strong></td>
                                                <td>Crop Field</td>
                                            </tr>
                                            <tr class="field-row" data-field="South Field B">
                                                <td><strong>South Field B</strong></td>
                                                <td>Crop Field</td>
                                            </tr>
                                            <tr class="field-row" data-field="East Field C">
                                                <td><strong>East Field C</strong></td>
                                                <td>Crop Field</td>
                                            </tr>
                                            <tr class="field-row" data-field="West Field D">
                                                <td><strong>West Field D</strong></td>
                                                <td>Crop Field</td>
                                            </tr>
                                            <tr class="field-row" data-field="Main Depot">
                                                <td><strong>Main Depot</strong></td>
                                                <td>Infrastructure</td>
                                            </tr>
                                            <tr class="field-row" data-field="Workshop Bay">
                                                <td><strong>Workshop Bay</strong></td>
                                                <td>Infrastructure</td>
                                            </tr>
                                            <tr class="field-row" data-field="Storage Facility">
                                                <td><strong>Storage Facility</strong></td>
                                                <td>Infrastructure</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 5: Fuel Data Entry -->
                    <div id="step-fuel-data" class="step hidden">
                        <h2>Fuel & Odometer Data</h2>
                        <button class="back-btn" id="back-to-field">‚Üê Back to Field</button>
                        <div class="form-container">
                            <div class="selected-info">
                                <div class="info-card">
                                    <div class="info-label">Vehicle</div>
                                    <div id="selected-vehicle-info-2"></div>
                                </div>
                                <div class="info-card">
                                    <div class="info-label">Activity</div>
                                    <div id="selected-activity-info"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="odo-start">Odometer Start (km) *</label>
                                    <input type="number" id="odo-start" required min="0" step="0.1">
                                </div>
                                
                                <div class="form-group">
                                    <label for="odo-end">Odometer End (km) *</label>
                                    <input type="number" id="odo-end" required min="0" step="0.1">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="litres-used">Litres Used *</label>
                                <input type="number" id="litres-used" required min="0" step="0.01">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="bowser-start">Bowser Start Reading (L) *</label>
                                    <input type="number" id="bowser-start" required min="0" step="0.01">
                                </div>
                                
                                <div class="form-group">
                                    <label for="bowser-end">Bowser End Reading (L) *</label>
                                    <input type="number" id="bowser-end" required min="0" step="0.01">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="fuel-consumption">Fuel Consumption (L/100km)</label>
                                <input type="text" id="fuel-consumption" readonly>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="gauge-broken">
                                <label for="gauge-broken" class="mb-0">Gauge broken (use start ODO as end ODO)</label>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" id="next-to-review" class="btn btn-primary">Next: Review & Save ‚Üí</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 5: Review & Save -->
                    <div id="step-review" class="step hidden">
                        <h2>Review & Save Record</h2>
                        <button class="back-btn" id="back-to-fuel-data">‚Üê Back to Fuel Data</button>
                        <div class="form-container">
                            <div id="review-summary">
                                <!-- Summary will be populated by JavaScript -->
                            </div>
                            
                            <div class="form-group">
                                <label for="date">Date *</label>
                                <input type="date" id="date" required>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="needs-review">
                                <label for="needs-review" class="mb-0">Flag for review (incomplete information)</label>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" id="cancel-entry" class="btn btn-secondary">Cancel</button>
                                <button type="button" id="save-fuel-record" class="btn btn-primary">Save Record</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Vehicle Management Section -->
            <section id="vehicles-section" class="section">
                <div class="container">
                    <div class="section-header">
                        <h2>Vehicle Management</h2>
                        <button id="add-vehicle" class="btn btn-primary">+ Add Vehicle</button>
                    </div>
                    <div class="table-container">
                        <table class="table compact-table mobile-table" id="vehicles-management-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Type</th>
                                    <th>Name</th>
                                    <th>ODO</th>
                                </tr>
                            </thead>
                            <tbody id="vehicles-management-body">
                                <!-- Vehicle management list will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Driver Management Section -->
            <section id="drivers-section" class="section">
                <div class="container">
                    <div class="section-header">
                        <h2>Driver Management</h2>
                        <button id="add-driver" class="btn btn-primary">+ Add Driver</button>
                    </div>
                    <div class="table-container">
                        <table class="table compact-table mobile-table" id="drivers-management-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>License</th>
                                </tr>
                            </thead>
                            <tbody id="drivers-management-body">
                                <!-- Driver management list will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Dashboard Section -->
            <section id="dashboard-section" class="section">
                <div class="container dashboard-container">
                    <div class="dashboard-header">
                        <h2>Dashboard</h2>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card" id="tank-status-card">
                            <div class="stat-icon">üõ¢Ô∏è</div>
                            <div class="stat-content">
                                <div class="stat-value" id="tank-level">0 L</div>
                                <div class="stat-label">Tank Level</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">‚õΩ</div>
                            <div class="stat-content">
                                <div class="stat-value" id="monthly-fuel">0 L</div>
                                <div class="stat-label">Fuel This Month</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üìÖ</div>
                            <div class="stat-content">
                                <div class="stat-value" id="daily-fuel">0 L</div>
                                <div class="stat-label">Fuel Today</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üöõ</div>
                            <div class="stat-content">
                                <div class="stat-value" id="vehicles-refueled-today">0</div>
                                <div class="stat-label">Vehicles Today</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">‚ö†Ô∏è</div>
                            <div class="stat-content">
                                <div class="stat-value" id="discrepancy-count">0</div>
                                <div class="stat-label">Discrepancies</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üìà</div>
                            <div class="stat-content">
                                <div class="stat-value" id="worst-performer">-</div>
                                <div class="stat-label">Highest Consumer</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-actions">
                        <button id="export-monthly" class="btn btn-primary btn-compact">üìÑ Monthly</button>
                        <button id="export-annual" class="btn btn-secondary btn-compact">üìã Annual</button>
                        <button id="export-canepro" class="btn btn-success btn-compact">üìä CanePro</button>
                    </div>
                    
                    <div class="activity-calendar">
                        <h3>Fleet Activity Overview</h3>
                        <div class="calendar-container">
                            <div id="calendar-weeks" class="calendar-weeks">
                                <!-- Week numbers will be populated by JavaScript -->
                            </div>
                            <div id="activity-calendar-grid" class="calendar-grid">
                                <!-- Activity calendar will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="calendar-legend">
                            <span class="legend-item">
                                <div class="calendar-cell"></div> No activity
                            </span>
                            <span class="legend-item">
                                <div class="calendar-cell level-1"></div> 1-2 records
                            </span>
                            <span class="legend-item">
                                <div class="calendar-cell level-2"></div> 3-4 records
                            </span>
                            <span class="legend-item">
                                <div class="calendar-cell level-3"></div> 5-6 records
                            </span>
                            <span class="legend-item">
                                <div class="calendar-cell level-4"></div> 7+ records
                            </span>
                        </div>
                    </div>
                    
                    <div class="vehicle-summary">
                        <div class="section-header-with-toggle">
                            <h3>Vehicle Summary</h3>
                            <div class="toggle-buttons">
                                <button class="toggle-btn active" data-period="week">This Week</button>
                                <button class="toggle-btn" data-period="month">This Month</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table" id="vehicle-summary-table">
                                <thead>
                                    <tr>
                                        <th class="vehicle-col">Vehicle</th>
                                        <th class="fuel-col">Fuel (L)</th>
                                        <th class="hrskm-col">HrsKm</th>
                                        <th class="consumption-col">L/100km</th>
                                        <th class="records-col">#</th>
                                    </tr>
                                </thead>
                                <tbody id="vehicle-summary-body">
                                    <!-- Table will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="recent-records">
                        <div class="section-header-with-toggle">
                            <h3>Recent Fuel Records</h3>
                            <div class="toggle-buttons">
                                <button class="toggle-btn" data-period="today">Today</button>
                                <button class="toggle-btn active" data-period="week">This Week</button>
                                <button class="toggle-btn" data-period="month">This Month</button>
                                <button class="toggle-btn" data-period="all">All</button>
                            </div>
                        </div>
                        <div id="recent-records-table">
                            <!-- Table will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Bowser Management Section -->
            <section id="bowsers-section" class="section">
                <div class="container">
                    <div class="section-header">
                        <h2>Bowser Management</h2>
                        <button id="add-bowser" class="btn btn-primary">+ Add Bowser</button>
                    </div>
                    <div class="table-container">
                        <table class="table compact-table mobile-table" id="bowsers-management-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Capacity (L)</th>
                                    <th>Current Reading (L)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="bowsers-management-body">
                                <!-- Bowser management list will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div class="bowser-refill-section">
                        <div class="section-header">
                            <h3>Tank Refill History</h3>
                            <button id="add-refill" class="btn btn-success">+ Record Refill</button>
                        </div>
                        <div class="table-container">
                            <table class="table" id="refill-history-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Bowser</th>
                                        <th>Supplier</th>
                                        <th>Amount (L)</th>
                                        <th>Reading Before</th>
                                        <th>Reading After</th>
                                        <th>Cost</th>
                                    </tr>
                                </thead>
                                <tbody id="refill-history-body">
                                    <!-- Refill history will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="reconciliation-section">
                        <div class="section-header">
                            <h3>Monthly Reconciliation</h3>
                            <button id="reconcile-month" class="btn btn-warning">üìä Reconcile Current Month</button>
                        </div>
                        <div id="reconciliation-status">
                            <!-- Reconciliation status will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-nav">
            <button class="mobile-nav-btn active" data-section="fuel-entry">
                <span class="nav-icon">‚õΩ</span>
                <span class="nav-label">Fuel Entry</span>
            </button>
            <button class="mobile-nav-btn" data-section="dashboard">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Dashboard</span>
            </button>
            <button class="mobile-nav-btn" data-section="database">
                <span class="nav-icon">üóÉÔ∏è</span>
                <span class="nav-label">Database</span>
            </button>
        </nav>

    </div>

    <script src="app.js?v=8"></script>
</body>
</html>